<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://aframe.io https://cdn.jsdelivr.net https://www.gstatic.com blob: data:; img-src 'self' data: blob: https://*; connect-src 'self' https://* blob: data:;">

    <title>VirtualMenus_App</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #unity-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; background: transparent; }
        #unity-canvas { width: 100%; height: 100%; background: transparent; }
        
        /* Capa de carga */
        #loading-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 1000; 
        }
        #loading-bar-container { width: 250px; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 20px; }
        #loading-bar-full { width: 0%; height: 100%; background: #2196f3; transition: width 0.2s; }
        #loading-text { font-family: sans-serif; margin-top: 10px; color: #555; font-size: 14px; }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <img src="SplashVirtualMenus.jpg" style="width: 200px;">
        <div id="loading-bar-container"><div id="loading-bar-full"></div></div>
        <p id="loading-text">Cargando Menú: 0%</p>
    </div>

    <a-scene mindar-image="imageTargetSrc: targets.mind; autoStart: true; uiLoading: no; uiScanning: no;" 
             embedded color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity mindar-image-target="targetIndex: 0"></a-entity>
    </a-scene>

    <div id="unity-container">
        <canvas id="unity-canvas"></canvas>
    </div>

    <script>
        const overlay = document.querySelector("#loading-overlay");
        const progressBarFull = document.querySelector("#loading-bar-full");
        const progressText = document.querySelector("#loading-text");
        const canvas = document.querySelector("#unity-canvas");

        const buildUrl = "Build";
        const loaderUrl = buildUrl + "/export_virtualmenuapp.loader.js";
        const config = {
            dataUrl: buildUrl + "/export_virtualmenuapp.data",
            frameworkUrl: buildUrl + "/export_virtualmenuapp.framework.js",
            codeUrl: buildUrl + "/export_virtualmenuapp.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "Virtual_Menus",
            productName: "VirtualMenus_App",
            productVersion: "0.1",
        };

        const script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                const percent = Math.round(progress * 100);
                progressBarFull.style.width = percent + "%";
                progressText.innerHTML = "Cargando Menú: " + percent + "%";
            }).then((unityInstance) => {
                // Ocultamos la carga y dejamos que Unity tome el control transparente
                setTimeout(() => {
                    overlay.style.display = "none";
                }, 1000);
            }).catch((message) => {
                alert("Error al cargar Unity: " + message);
            });
        };
        document.body.appendChild(script);

        // Truco para móviles: Un toque en la pantalla negra puede despertar la cámara
        document.body.addEventListener("click", () => {
            const sceneEl = document.querySelector('a-scene');
            if (sceneEl.systems['mindar-image-system']) {
                sceneEl.systems['mindar-image-system'].start(); 
            }
        }, {once: true});
    </script>
</body>
</html>
